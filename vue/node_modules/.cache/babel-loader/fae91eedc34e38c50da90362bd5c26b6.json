{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\nimport { a as TextTrack, T as TextTrackSymbol, l as loadScript, p as preconnect } from '../chunks/vidstack-dd29a7a5.js';\nimport { L as ListSymbol, I as IS_CHROME, i as isHLSSupported } from '../chunks/vidstack-e4c46e48.js';\nimport { VideoProvider } from './vidstack-video.js';\nimport { p as peek, D as DOMEvent, l as listenEvent, e as effect, x as camelToKebabCase, y as isUndefined, k as isString, z as isFunction } from '../chunks/vidstack-b8ba7e3c.js';\nimport { Q as QualitySymbol, c as coerceToError } from '../chunks/vidstack-ba5dcbce.js';\nimport { R as RAFLoop } from '../chunks/vidstack-644e676d.js';\nimport 'media-captions';\n\nconst toDOMEventType = type => camelToKebabCase(type);\n\nclass HLSController {\n  constructor(_video) {\n    this._video = _video;\n    this._instance = null;\n    this._stopLiveSync = null;\n    this._config = {};\n    this._callbacks = /* @__PURE__ */new Set();\n  }\n\n  get instance() {\n    return this._instance;\n  }\n\n  setup(ctor, context) {\n    this._ctx = context;\n    const isLive = peek(context.$state.streamType).includes(\"live\"),\n          isLiveLowLatency = peek(context.$state.streamType).includes(\"ll-\");\n    this._instance = new ctor({\n      lowLatencyMode: isLiveLowLatency,\n      backBufferLength: isLiveLowLatency ? 4 : isLive ? 8 : void 0,\n      renderTextTracksNatively: false,\n      ...this._config\n    });\n\n    const dispatcher = this._dispatchHLSEvent.bind(this);\n\n    for (const event of Object.values(ctor.Events)) this._instance.on(event, dispatcher);\n\n    this._instance.on(ctor.Events.ERROR, this._onError.bind(this));\n\n    for (const callback of this._callbacks) callback(this._instance);\n\n    context.player.dispatch(new DOMEvent(\"hls-instance\", {\n      detail: this._instance\n    }));\n\n    this._instance.attachMedia(this._video);\n\n    this._instance.on(ctor.Events.AUDIO_TRACK_SWITCHED, this._onAudioSwitch.bind(this));\n\n    this._instance.on(ctor.Events.LEVEL_SWITCHED, this._onLevelSwitched.bind(this));\n\n    this._instance.on(ctor.Events.LEVEL_LOADED, this._onLevelLoaded.bind(this));\n\n    this._instance.on(ctor.Events.NON_NATIVE_TEXT_TRACKS_FOUND, this._onTracksFound.bind(this));\n\n    this._instance.on(ctor.Events.CUES_PARSED, this._onCuesParsed.bind(this));\n\n    context.qualities[QualitySymbol._enableAuto] = this._enableAutoQuality.bind(this);\n    listenEvent(context.qualities, \"change\", this._onQualityChange.bind(this));\n    listenEvent(context.audioTracks, \"change\", this._onAudioChange.bind(this));\n    this._stopLiveSync = effect(this._liveSync.bind(this));\n  }\n\n  _liveSync() {\n    if (!this._ctx.$state.live()) return;\n    const raf = new RAFLoop(this._liveSyncPosition.bind(this));\n\n    raf._start();\n\n    return raf._stop.bind(raf);\n  }\n\n  _liveSyncPosition() {\n    this._ctx.$state.liveSyncPosition.set(this._instance?.liveSyncPosition ?? Infinity);\n  }\n\n  _dispatchHLSEvent(eventType, detail) {\n    this._ctx.player?.dispatch(new DOMEvent(toDOMEventType(eventType), {\n      detail\n    }));\n  }\n\n  _onTracksFound(eventType, data) {\n    const event = new DOMEvent(eventType, {\n      detail: data\n    });\n    let currentTrack = -1;\n\n    for (let i = 0; i < data.tracks.length; i++) {\n      const nonNativeTrack = data.tracks[i],\n            init = nonNativeTrack.subtitleTrack ?? nonNativeTrack.closedCaptions,\n            track = new TextTrack({\n        id: `hls-${nonNativeTrack.kind}${i}`,\n        src: init?.url,\n        label: nonNativeTrack.label,\n        language: init?.lang,\n        kind: nonNativeTrack.kind\n      });\n      track[TextTrackSymbol._readyState] = 2;\n\n      track[TextTrackSymbol._onModeChange] = () => {\n        if (track.mode === \"showing\") {\n          this._instance.subtitleTrack = i;\n          currentTrack = i;\n        } else if (currentTrack === i) {\n          this._instance.subtitleTrack = -1;\n          currentTrack = -1;\n        }\n      };\n\n      if (nonNativeTrack.default) track.setMode(\"showing\", event);\n\n      this._ctx.textTracks.add(track, event);\n    }\n  }\n\n  _onCuesParsed(eventType, data) {\n    const track = this._ctx.textTracks.getById(`hls-${data.track}`);\n\n    if (!track) return;\n    const event = new DOMEvent(eventType, {\n      detail: data\n    });\n\n    for (const cue of data.cues) {\n      cue.positionAlign = \"auto\";\n      track.addCue(cue, event);\n    }\n  }\n\n  _onAudioSwitch(eventType, data) {\n    const track = this._ctx.audioTracks[data.id];\n\n    if (track) {\n      this._ctx.audioTracks[ListSymbol._select](track, true, new DOMEvent(eventType, {\n        detail: data\n      }));\n    }\n  }\n\n  _onLevelSwitched(eventType, data) {\n    const quality = this._ctx.qualities[data.level];\n\n    if (quality) {\n      this._ctx.qualities[ListSymbol._select](quality, true, new DOMEvent(eventType, {\n        detail: data\n      }));\n    }\n  }\n\n  _onLevelLoaded(eventType, data) {\n    if (this._ctx.$state.canPlay()) return;\n    const {\n      type,\n      live,\n      totalduration: duration,\n      targetduration\n    } = data.details;\n    const event = new DOMEvent(eventType, {\n      detail: data\n    });\n\n    this._ctx.delegate._dispatch(\"stream-type-change\", {\n      detail: live ? type === \"EVENT\" && Number.isFinite(duration) && targetduration >= 10 ? \"live:dvr\" : \"live\" : \"on-demand\",\n      trigger: event\n    });\n\n    this._ctx.delegate._dispatch(\"duration-change\", {\n      detail: duration,\n      trigger: event\n    });\n\n    const media = this._instance.media;\n\n    if (this._instance.currentLevel === -1) {\n      this._ctx.qualities[QualitySymbol._setAuto](true, event);\n    }\n\n    for (const track of this._instance.audioTracks) {\n      this._ctx.audioTracks[ListSymbol._add]({\n        id: track.id + \"\",\n        label: track.name,\n        language: track.lang || \"\",\n        kind: \"main\"\n      }, event);\n    }\n\n    for (const level of this._instance.levels) {\n      this._ctx.qualities[ListSymbol._add]({\n        width: level.width,\n        height: level.height,\n        codec: level.codecSet,\n        bitrate: level.bitrate\n      }, event);\n    }\n\n    media.dispatchEvent(new DOMEvent(\"canplay\", {\n      trigger: event\n    }));\n  }\n\n  _onError(eventType, data) {\n    {\n      this._ctx.logger?.errorGroup(`HLS error \\`${eventType}\\``).labelledLog(\"Media Element\", this._instance?.media).labelledLog(\"HLS Instance\", this._instance).labelledLog(\"Event Type\", eventType).labelledLog(\"Data\", data).labelledLog(\"Src\", peek(this._ctx.$state.source)).labelledLog(\"Media Store\", { ...this._ctx.$state\n      }).dispatch();\n    }\n\n    if (data.fatal) {\n      switch (data.type) {\n        case \"networkError\":\n          this._instance?.startLoad();\n          break;\n\n        case \"mediaError\":\n          this._instance?.recoverMediaError();\n          break;\n\n        default:\n          this._instance?.destroy();\n          this._instance = null;\n          break;\n      }\n    }\n  }\n\n  _enableAutoQuality() {\n    if (this._instance) this._instance.currentLevel = -1;\n  }\n\n  _onQualityChange() {\n    const {\n      qualities\n    } = this._ctx;\n    if (!this._instance || qualities.auto) return;\n    this._instance[qualities.switch + \"Level\"] = qualities.selectedIndex;\n    if (IS_CHROME) this._video.currentTime = this._video.currentTime;\n  }\n\n  _onAudioChange() {\n    const {\n      audioTracks\n    } = this._ctx;\n\n    if (this._instance && this._instance.audioTrack !== audioTracks.selectedIndex) {\n      this._instance.audioTrack = audioTracks.selectedIndex;\n    }\n  }\n\n  _destroy() {\n    if (this._ctx) this._ctx.qualities[QualitySymbol._enableAuto] = void 0;\n    this._instance?.destroy();\n    this._instance = null;\n    this._stopLiveSync?.();\n    this._stopLiveSync = null;\n    this._ctx?.logger?.info(\"\\u{1F3D7}\\uFE0F Destroyed HLS instance\");\n  }\n\n}\n\nclass HLSLibLoader {\n  constructor(_lib, _ctx, _callback) {\n    this._lib = _lib;\n    this._ctx = _ctx;\n    this._callback = _callback;\n\n    this._startLoading();\n  }\n\n  async _startLoading() {\n    this._ctx.logger?.info(\"\\u{1F3D7}\\uFE0F Loading HLS Library\");\n    const callbacks = {\n      onLoadStart: this._onLoadStart.bind(this),\n      onLoaded: this._onLoaded.bind(this),\n      onLoadError: this._onLoadError.bind(this)\n    };\n    let ctor = await loadHLSScript(this._lib, callbacks);\n    if (isUndefined(ctor) && !isString(this._lib)) ctor = await importHLS(this._lib, callbacks);\n    if (!ctor) return null;\n\n    if (!ctor.isSupported()) {\n      const message = \"[vidstack]: `hls.js` is not supported in this environment\";\n      this._ctx.logger?.error(message);\n\n      this._ctx.player.dispatch(new DOMEvent(\"hls-unsupported\"));\n\n      this._ctx.delegate._dispatch(\"error\", {\n        detail: {\n          message,\n          code: 4\n        }\n      });\n\n      return null;\n    }\n\n    return ctor;\n  }\n\n  _onLoadStart() {\n    {\n      this._ctx.logger?.infoGroup(\"Starting to load `hls.js`\").labelledLog(\"URL\", this._lib).dispatch();\n    }\n\n    this._ctx.player.dispatch(new DOMEvent(\"hls-lib-load-start\"));\n  }\n\n  _onLoaded(ctor) {\n    {\n      this._ctx.logger?.infoGroup(\"Loaded `hls.js`\").labelledLog(\"Library\", this._lib).labelledLog(\"Constructor\", ctor).dispatch();\n    }\n\n    this._ctx.player.dispatch(new DOMEvent(\"hls-lib-loaded\", {\n      detail: ctor\n    }));\n\n    this._callback(ctor);\n  }\n\n  _onLoadError(e) {\n    const error = coerceToError(e);\n    {\n      this._ctx.logger?.errorGroup(\"Failed to load `hls.js`\").labelledLog(\"Library\", this._lib).labelledLog(\"Error\", e).dispatch();\n    }\n\n    this._ctx.player.dispatch(new DOMEvent(\"hls-lib-load-error\", {\n      detail: error\n    }));\n\n    this._ctx.delegate._dispatch(\"error\", {\n      detail: {\n        message: error.message,\n        code: 4\n      }\n    });\n  }\n\n}\n\nasync function importHLS(loader, callbacks = {}) {\n  if (isUndefined(loader)) return void 0;\n  callbacks.onLoadStart?.();\n\n  if (loader.prototype && loader.prototype !== Function) {\n    callbacks.onLoaded?.(loader);\n    return loader;\n  }\n\n  try {\n    const ctor = (await loader())?.default;\n\n    if (ctor && !!ctor.isSupported) {\n      callbacks.onLoaded?.(ctor);\n    } else {\n      throw Error(true ? \"[vidstack] failed importing `hls.js`. Dynamic import returned invalid constructor.\" : \"\");\n    }\n\n    return ctor;\n  } catch (err) {\n    callbacks.onLoadError?.(err);\n  }\n\n  return void 0;\n}\n\nasync function loadHLSScript(src, callbacks = {}) {\n  if (!isString(src)) return void 0;\n  callbacks.onLoadStart?.();\n\n  try {\n    await loadScript(src);\n\n    if (!isFunction(window.Hls)) {\n      throw Error(true ? \"[vidstack] failed loading `hls.js`. Could not find a valid `Hls` constructor on window\" : \"\");\n    }\n\n    const ctor = window.Hls;\n    callbacks.onLoaded?.(ctor);\n    return ctor;\n  } catch (err) {\n    callbacks.onLoadError?.(err);\n  }\n\n  return void 0;\n}\n\nconst JS_DELIVR_CDN = \"https://cdn.jsdelivr.net\";\n\nclass HLSProvider extends VideoProvider {\n  constructor() {\n    super(...arguments);\n    this.$$PROVIDER_TYPE = \"HLS\";\n    this._ctor = null;\n    this._controller = new HLSController(this.video);\n    this._library = `${JS_DELIVR_CDN}/npm/hls.js@^1.0.0/dist/hls${\".js\"}`;\n  }\n  /**\n   * The `hls.js` constructor.\n   */\n\n\n  get ctor() {\n    return this._ctor;\n  }\n  /**\n   * The current `hls.js` instance.\n   */\n\n\n  get instance() {\n    return this._controller.instance;\n  }\n\n  get type() {\n    return \"hls\";\n  }\n\n  get canLiveSync() {\n    return true;\n  }\n  /**\n   * The `hls.js` configuration object.\n   *\n   * @see {@link https://github.com/video-dev/hls.js/blob/master/docs/API.md#fine-tuning}\n   */\n\n\n  get config() {\n    return this._controller._config;\n  }\n\n  set config(config) {\n    this._controller._config = config;\n  }\n  /**\n   * The `hls.js` constructor (supports dynamic imports) or a URL of where it can be found.\n   *\n   * @defaultValue `https://cdn.jsdelivr.net/npm/hls.js@^1.0.0/dist/hls.min.js`\n   */\n\n\n  get library() {\n    return this._library;\n  }\n\n  set library(library) {\n    this._library = library;\n  }\n\n  preconnect() {\n    if (!isString(this._library)) return;\n    preconnect(this._library);\n  }\n\n  setup(context) {\n    super.setup(context);\n    new HLSLibLoader(this._library, context, ctor => {\n      this._ctor = ctor;\n\n      this._controller.setup(ctor, context);\n\n      context.delegate._dispatch(\"provider-setup\", {\n        detail: this\n      });\n\n      const src = peek(context.$state.source);\n      if (src) this.loadSource(src);\n    });\n  }\n\n  async loadSource(src, preload) {\n    if (!isString(src.src)) return;\n    this._media.preload = preload || \"\";\n    this._controller.instance?.loadSource(src.src);\n    this._currentSrc = src;\n  }\n  /**\n   * The given callback is invoked when a new `hls.js` instance is created and right before it's\n   * attached to media.\n   */\n\n\n  onInstance(callback) {\n    const instance = this._controller.instance;\n    if (instance) callback(instance);\n\n    this._controller._callbacks.add(callback);\n\n    return () => this._controller._callbacks.delete(callback);\n  }\n\n  destroy() {\n    this._controller._destroy();\n  }\n\n}\n\n/**\n * Whether `hls.js` is supported in this environment.\n */\nHLSProvider.supported = isHLSSupported();\nexport { HLSProvider };","map":{"version":3,"sources":["/home/ann/dev/studip/54/public/plugins_packages/RasmusFuhse/LernmodulePlugin/vue/node_modules/vidstack/dist/dev/providers/vidstack-hls.js"],"names":["a","TextTrack","T","TextTrackSymbol","l","loadScript","p","preconnect","L","ListSymbol","I","IS_CHROME","i","isHLSSupported","VideoProvider","peek","D","DOMEvent","listenEvent","e","effect","x","camelToKebabCase","y","isUndefined","k","isString","z","isFunction","Q","QualitySymbol","c","coerceToError","R","RAFLoop","toDOMEventType","type","HLSController","constructor","_video","_instance","_stopLiveSync","_config","_callbacks","Set","instance","setup","ctor","context","_ctx","isLive","$state","streamType","includes","isLiveLowLatency","lowLatencyMode","backBufferLength","renderTextTracksNatively","dispatcher","_dispatchHLSEvent","bind","event","Object","values","Events","on","ERROR","_onError","callback","player","dispatch","detail","attachMedia","AUDIO_TRACK_SWITCHED","_onAudioSwitch","LEVEL_SWITCHED","_onLevelSwitched","LEVEL_LOADED","_onLevelLoaded","NON_NATIVE_TEXT_TRACKS_FOUND","_onTracksFound","CUES_PARSED","_onCuesParsed","qualities","_enableAuto","_enableAutoQuality","_onQualityChange","audioTracks","_onAudioChange","_liveSync","live","raf","_liveSyncPosition","_start","_stop","liveSyncPosition","set","Infinity","eventType","data","currentTrack","tracks","length","nonNativeTrack","init","subtitleTrack","closedCaptions","track","id","kind","src","url","label","language","lang","_readyState","_onModeChange","mode","default","setMode","textTracks","add","getById","cue","cues","positionAlign","addCue","_select","quality","level","canPlay","totalduration","duration","targetduration","details","delegate","_dispatch","Number","isFinite","trigger","media","currentLevel","_setAuto","_add","name","levels","width","height","codec","codecSet","bitrate","dispatchEvent","logger","errorGroup","labelledLog","source","fatal","startLoad","recoverMediaError","destroy","auto","switch","selectedIndex","currentTime","audioTrack","_destroy","info","HLSLibLoader","_lib","_callback","_startLoading","callbacks","onLoadStart","_onLoadStart","onLoaded","_onLoaded","onLoadError","_onLoadError","loadHLSScript","importHLS","isSupported","message","error","code","infoGroup","loader","prototype","Function","Error","err","window","Hls","JS_DELIVR_CDN","HLSProvider","arguments","$$PROVIDER_TYPE","_ctor","_controller","video","_library","canLiveSync","config","library","loadSource","preload","_media","_currentSrc","onInstance","delete","supported"],"mappings":"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","sourcesContent":["import { a as TextTrack, T as TextTrackSymbol, l as loadScript, p as preconnect } from '../chunks/vidstack-dd29a7a5.js';\nimport { L as ListSymbol, I as IS_CHROME, i as isHLSSupported } from '../chunks/vidstack-e4c46e48.js';\nimport { VideoProvider } from './vidstack-video.js';\nimport { p as peek, D as DOMEvent, l as listenEvent, e as effect, x as camelToKebabCase, y as isUndefined, k as isString, z as isFunction } from '../chunks/vidstack-b8ba7e3c.js';\nimport { Q as QualitySymbol, c as coerceToError } from '../chunks/vidstack-ba5dcbce.js';\nimport { R as RAFLoop } from '../chunks/vidstack-644e676d.js';\nimport 'media-captions';\n\nconst toDOMEventType = (type) => camelToKebabCase(type);\nclass HLSController {\n  constructor(_video) {\n    this._video = _video;\n    this._instance = null;\n    this._stopLiveSync = null;\n    this._config = {};\n    this._callbacks = /* @__PURE__ */ new Set();\n  }\n  get instance() {\n    return this._instance;\n  }\n  setup(ctor, context) {\n    this._ctx = context;\n    const isLive = peek(context.$state.streamType).includes(\"live\"), isLiveLowLatency = peek(context.$state.streamType).includes(\"ll-\");\n    this._instance = new ctor({\n      lowLatencyMode: isLiveLowLatency,\n      backBufferLength: isLiveLowLatency ? 4 : isLive ? 8 : void 0,\n      renderTextTracksNatively: false,\n      ...this._config\n    });\n    const dispatcher = this._dispatchHLSEvent.bind(this);\n    for (const event of Object.values(ctor.Events))\n      this._instance.on(event, dispatcher);\n    this._instance.on(ctor.Events.ERROR, this._onError.bind(this));\n    for (const callback of this._callbacks)\n      callback(this._instance);\n    context.player.dispatch(new DOMEvent(\"hls-instance\", { detail: this._instance }));\n    this._instance.attachMedia(this._video);\n    this._instance.on(ctor.Events.AUDIO_TRACK_SWITCHED, this._onAudioSwitch.bind(this));\n    this._instance.on(ctor.Events.LEVEL_SWITCHED, this._onLevelSwitched.bind(this));\n    this._instance.on(ctor.Events.LEVEL_LOADED, this._onLevelLoaded.bind(this));\n    this._instance.on(ctor.Events.NON_NATIVE_TEXT_TRACKS_FOUND, this._onTracksFound.bind(this));\n    this._instance.on(ctor.Events.CUES_PARSED, this._onCuesParsed.bind(this));\n    context.qualities[QualitySymbol._enableAuto] = this._enableAutoQuality.bind(this);\n    listenEvent(context.qualities, \"change\", this._onQualityChange.bind(this));\n    listenEvent(context.audioTracks, \"change\", this._onAudioChange.bind(this));\n    this._stopLiveSync = effect(this._liveSync.bind(this));\n  }\n  _liveSync() {\n    if (!this._ctx.$state.live())\n      return;\n    const raf = new RAFLoop(this._liveSyncPosition.bind(this));\n    raf._start();\n    return raf._stop.bind(raf);\n  }\n  _liveSyncPosition() {\n    this._ctx.$state.liveSyncPosition.set(this._instance?.liveSyncPosition ?? Infinity);\n  }\n  _dispatchHLSEvent(eventType, detail) {\n    this._ctx.player?.dispatch(new DOMEvent(toDOMEventType(eventType), { detail }));\n  }\n  _onTracksFound(eventType, data) {\n    const event = new DOMEvent(eventType, { detail: data });\n    let currentTrack = -1;\n    for (let i = 0; i < data.tracks.length; i++) {\n      const nonNativeTrack = data.tracks[i], init = nonNativeTrack.subtitleTrack ?? nonNativeTrack.closedCaptions, track = new TextTrack({\n        id: `hls-${nonNativeTrack.kind}${i}`,\n        src: init?.url,\n        label: nonNativeTrack.label,\n        language: init?.lang,\n        kind: nonNativeTrack.kind\n      });\n      track[TextTrackSymbol._readyState] = 2;\n      track[TextTrackSymbol._onModeChange] = () => {\n        if (track.mode === \"showing\") {\n          this._instance.subtitleTrack = i;\n          currentTrack = i;\n        } else if (currentTrack === i) {\n          this._instance.subtitleTrack = -1;\n          currentTrack = -1;\n        }\n      };\n      if (nonNativeTrack.default)\n        track.setMode(\"showing\", event);\n      this._ctx.textTracks.add(track, event);\n    }\n  }\n  _onCuesParsed(eventType, data) {\n    const track = this._ctx.textTracks.getById(`hls-${data.track}`);\n    if (!track)\n      return;\n    const event = new DOMEvent(eventType, { detail: data });\n    for (const cue of data.cues) {\n      cue.positionAlign = \"auto\";\n      track.addCue(cue, event);\n    }\n  }\n  _onAudioSwitch(eventType, data) {\n    const track = this._ctx.audioTracks[data.id];\n    if (track) {\n      this._ctx.audioTracks[ListSymbol._select](\n        track,\n        true,\n        new DOMEvent(eventType, { detail: data })\n      );\n    }\n  }\n  _onLevelSwitched(eventType, data) {\n    const quality = this._ctx.qualities[data.level];\n    if (quality) {\n      this._ctx.qualities[ListSymbol._select](\n        quality,\n        true,\n        new DOMEvent(eventType, { detail: data })\n      );\n    }\n  }\n  _onLevelLoaded(eventType, data) {\n    if (this._ctx.$state.canPlay())\n      return;\n    const { type, live, totalduration: duration, targetduration } = data.details;\n    const event = new DOMEvent(eventType, { detail: data });\n    this._ctx.delegate._dispatch(\"stream-type-change\", {\n      detail: live ? type === \"EVENT\" && Number.isFinite(duration) && targetduration >= 10 ? \"live:dvr\" : \"live\" : \"on-demand\",\n      trigger: event\n    });\n    this._ctx.delegate._dispatch(\"duration-change\", { detail: duration, trigger: event });\n    const media = this._instance.media;\n    if (this._instance.currentLevel === -1) {\n      this._ctx.qualities[QualitySymbol._setAuto](true, event);\n    }\n    for (const track of this._instance.audioTracks) {\n      this._ctx.audioTracks[ListSymbol._add](\n        {\n          id: track.id + \"\",\n          label: track.name,\n          language: track.lang || \"\",\n          kind: \"main\"\n        },\n        event\n      );\n    }\n    for (const level of this._instance.levels) {\n      this._ctx.qualities[ListSymbol._add](\n        {\n          width: level.width,\n          height: level.height,\n          codec: level.codecSet,\n          bitrate: level.bitrate\n        },\n        event\n      );\n    }\n    media.dispatchEvent(new DOMEvent(\"canplay\", { trigger: event }));\n  }\n  _onError(eventType, data) {\n    {\n      this._ctx.logger?.errorGroup(`HLS error \\`${eventType}\\``).labelledLog(\"Media Element\", this._instance?.media).labelledLog(\"HLS Instance\", this._instance).labelledLog(\"Event Type\", eventType).labelledLog(\"Data\", data).labelledLog(\"Src\", peek(this._ctx.$state.source)).labelledLog(\"Media Store\", { ...this._ctx.$state }).dispatch();\n    }\n    if (data.fatal) {\n      switch (data.type) {\n        case \"networkError\":\n          this._instance?.startLoad();\n          break;\n        case \"mediaError\":\n          this._instance?.recoverMediaError();\n          break;\n        default:\n          this._instance?.destroy();\n          this._instance = null;\n          break;\n      }\n    }\n  }\n  _enableAutoQuality() {\n    if (this._instance)\n      this._instance.currentLevel = -1;\n  }\n  _onQualityChange() {\n    const { qualities } = this._ctx;\n    if (!this._instance || qualities.auto)\n      return;\n    this._instance[qualities.switch + \"Level\"] = qualities.selectedIndex;\n    if (IS_CHROME)\n      this._video.currentTime = this._video.currentTime;\n  }\n  _onAudioChange() {\n    const { audioTracks } = this._ctx;\n    if (this._instance && this._instance.audioTrack !== audioTracks.selectedIndex) {\n      this._instance.audioTrack = audioTracks.selectedIndex;\n    }\n  }\n  _destroy() {\n    if (this._ctx)\n      this._ctx.qualities[QualitySymbol._enableAuto] = void 0;\n    this._instance?.destroy();\n    this._instance = null;\n    this._stopLiveSync?.();\n    this._stopLiveSync = null;\n    this._ctx?.logger?.info(\"\\u{1F3D7}\\uFE0F Destroyed HLS instance\");\n  }\n}\n\nclass HLSLibLoader {\n  constructor(_lib, _ctx, _callback) {\n    this._lib = _lib;\n    this._ctx = _ctx;\n    this._callback = _callback;\n    this._startLoading();\n  }\n  async _startLoading() {\n    this._ctx.logger?.info(\"\\u{1F3D7}\\uFE0F Loading HLS Library\");\n    const callbacks = {\n      onLoadStart: this._onLoadStart.bind(this),\n      onLoaded: this._onLoaded.bind(this),\n      onLoadError: this._onLoadError.bind(this)\n    };\n    let ctor = await loadHLSScript(this._lib, callbacks);\n    if (isUndefined(ctor) && !isString(this._lib))\n      ctor = await importHLS(this._lib, callbacks);\n    if (!ctor)\n      return null;\n    if (!ctor.isSupported()) {\n      const message = \"[vidstack]: `hls.js` is not supported in this environment\";\n      this._ctx.logger?.error(message);\n      this._ctx.player.dispatch(new DOMEvent(\"hls-unsupported\"));\n      this._ctx.delegate._dispatch(\"error\", { detail: { message, code: 4 } });\n      return null;\n    }\n    return ctor;\n  }\n  _onLoadStart() {\n    {\n      this._ctx.logger?.infoGroup(\"Starting to load `hls.js`\").labelledLog(\"URL\", this._lib).dispatch();\n    }\n    this._ctx.player.dispatch(new DOMEvent(\"hls-lib-load-start\"));\n  }\n  _onLoaded(ctor) {\n    {\n      this._ctx.logger?.infoGroup(\"Loaded `hls.js`\").labelledLog(\"Library\", this._lib).labelledLog(\"Constructor\", ctor).dispatch();\n    }\n    this._ctx.player.dispatch(\n      new DOMEvent(\"hls-lib-loaded\", {\n        detail: ctor\n      })\n    );\n    this._callback(ctor);\n  }\n  _onLoadError(e) {\n    const error = coerceToError(e);\n    {\n      this._ctx.logger?.errorGroup(\"Failed to load `hls.js`\").labelledLog(\"Library\", this._lib).labelledLog(\"Error\", e).dispatch();\n    }\n    this._ctx.player.dispatch(\n      new DOMEvent(\"hls-lib-load-error\", {\n        detail: error\n      })\n    );\n    this._ctx.delegate._dispatch(\"error\", {\n      detail: { message: error.message, code: 4 }\n    });\n  }\n}\nasync function importHLS(loader, callbacks = {}) {\n  if (isUndefined(loader))\n    return void 0;\n  callbacks.onLoadStart?.();\n  if (loader.prototype && loader.prototype !== Function) {\n    callbacks.onLoaded?.(loader);\n    return loader;\n  }\n  try {\n    const ctor = (await loader())?.default;\n    if (ctor && !!ctor.isSupported) {\n      callbacks.onLoaded?.(ctor);\n    } else {\n      throw Error(\n        true ? \"[vidstack] failed importing `hls.js`. Dynamic import returned invalid constructor.\" : \"\"\n      );\n    }\n    return ctor;\n  } catch (err) {\n    callbacks.onLoadError?.(err);\n  }\n  return void 0;\n}\nasync function loadHLSScript(src, callbacks = {}) {\n  if (!isString(src))\n    return void 0;\n  callbacks.onLoadStart?.();\n  try {\n    await loadScript(src);\n    if (!isFunction(window.Hls)) {\n      throw Error(\n        true ? \"[vidstack] failed loading `hls.js`. Could not find a valid `Hls` constructor on window\" : \"\"\n      );\n    }\n    const ctor = window.Hls;\n    callbacks.onLoaded?.(ctor);\n    return ctor;\n  } catch (err) {\n    callbacks.onLoadError?.(err);\n  }\n  return void 0;\n}\n\nconst JS_DELIVR_CDN = \"https://cdn.jsdelivr.net\";\nclass HLSProvider extends VideoProvider {\n  constructor() {\n    super(...arguments);\n    this.$$PROVIDER_TYPE = \"HLS\";\n    this._ctor = null;\n    this._controller = new HLSController(this.video);\n    this._library = `${JS_DELIVR_CDN}/npm/hls.js@^1.0.0/dist/hls${\".js\" }`;\n  }\n  /**\n   * The `hls.js` constructor.\n   */\n  get ctor() {\n    return this._ctor;\n  }\n  /**\n   * The current `hls.js` instance.\n   */\n  get instance() {\n    return this._controller.instance;\n  }\n  static {\n    /**\n     * Whether `hls.js` is supported in this environment.\n     */\n    this.supported = isHLSSupported();\n  }\n  get type() {\n    return \"hls\";\n  }\n  get canLiveSync() {\n    return true;\n  }\n  /**\n   * The `hls.js` configuration object.\n   *\n   * @see {@link https://github.com/video-dev/hls.js/blob/master/docs/API.md#fine-tuning}\n   */\n  get config() {\n    return this._controller._config;\n  }\n  set config(config) {\n    this._controller._config = config;\n  }\n  /**\n   * The `hls.js` constructor (supports dynamic imports) or a URL of where it can be found.\n   *\n   * @defaultValue `https://cdn.jsdelivr.net/npm/hls.js@^1.0.0/dist/hls.min.js`\n   */\n  get library() {\n    return this._library;\n  }\n  set library(library) {\n    this._library = library;\n  }\n  preconnect() {\n    if (!isString(this._library))\n      return;\n    preconnect(this._library);\n  }\n  setup(context) {\n    super.setup(context);\n    new HLSLibLoader(this._library, context, (ctor) => {\n      this._ctor = ctor;\n      this._controller.setup(ctor, context);\n      context.delegate._dispatch(\"provider-setup\", { detail: this });\n      const src = peek(context.$state.source);\n      if (src)\n        this.loadSource(src);\n    });\n  }\n  async loadSource(src, preload) {\n    if (!isString(src.src))\n      return;\n    this._media.preload = preload || \"\";\n    this._controller.instance?.loadSource(src.src);\n    this._currentSrc = src;\n  }\n  /**\n   * The given callback is invoked when a new `hls.js` instance is created and right before it's\n   * attached to media.\n   */\n  onInstance(callback) {\n    const instance = this._controller.instance;\n    if (instance)\n      callback(instance);\n    this._controller._callbacks.add(callback);\n    return () => this._controller._callbacks.delete(callback);\n  }\n  destroy() {\n    this._controller._destroy();\n  }\n}\n\nexport { HLSProvider };\n"]},"metadata":{},"sourceType":"module"}